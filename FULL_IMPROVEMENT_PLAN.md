# План полного улучшения бота

## Обзор

Комплексное улучшение бота для достижения максимального качества и универсальности. Будут исправлены все баги, добавлена универсальность для любого типа бизнеса, оптимизирована производительность.

## Этап 1: Критические баги (13 задач)

### 1.1 Исправить streaming logic в chat.py
- Строка 238: Переделать логику `streaming_success`
- Убрать противоречие в условиях except блока
- Гарантировать корректную обработку успешных и неуспешных запросов

### 1.2 Исправить TimeoutError fallback
- Строка 298: Добавить корректный переход к fallback после таймаута
- Гарантировать что пользователь всегда получает ответ

### 1.3 Исправить race condition
- Строка 27: Добавить `asyncio.Lock` для `_last_tips_shown`
- Предотвратить потерю данных при параллельных запросах

### 1.4 Исправить filter_english_words
- Строка 135 text_filter.py: Переделать порядок операций
- Сначала удалять целые слова, затем заменять по словарю

### 1.5 Исправить search.py - ложные совпадения
- Строки 42, 53, 62: Использовать границы слов вместо `in`
- Добавить токенизацию для точного поиска

### 1.6 Гарантировать отмену animation_task
- Добавить `finally` блок для гарантированной отмены
- Предотвратить утечку задач

### 1.7 Добавить проверку длины сообщений
- Telegram лимит: 4096 символов
- Обрезать длинные сообщения с пометкой "..."

### 1.8 Заменить print() на logger
- Все print заменить на logger.info/debug/error
- Убрать try-except UnicodeEncodeError обертки

### 1.9 Добавить конкретные except блоки
- Заменить `except Exception` на конкретные типы
- Добавить логирование всех ошибок

### 1.10 Исправить fix_common_errors
- Использовать regex с границами слов
- Избежать замены подстрок внутри слов

### 1.11 Убрать дубликаты из COMMON_ERRORS
- Строка 95: Удалить "помочь вам": "помочь вам"

### 1.12 Использовать estimated_max_tokens из config
- Строка 162 chat.py: Заменить хардкод на значение из config

### 1.13 Проверка существования animation_task
- Добавить проверки перед cancel()
- Избежать ошибок при отсутствии задачи

## Этап 2: Универсальность (18 задач)

### 2.1 Создать систему профилей бизнеса
- Новый файл: `data/business_profiles.json`
- Профили: B2B Services, B2C Products, E-commerce, SaaS, Education, Healthcare, Real Estate
- Для каждого: tone, sales_strategy, communication_rules

### 2.2 Расширить структуру Company
- Добавить `metadata: dict[str, Any]`
- Сделать contacts списком вместо фиксированных полей
- Добавить `business_type` и `industry`

### 2.3 Расширить структуру Service
- Добавить `entity_type: str` (service/product/subscription/course)
- Добавить `metadata: dict[str, Any]` для расширения
- Сделать price опциональным
- Добавить поддержку разных валют

### 2.4 Вынести примеры диалогов в JSON
- Создать `data/conversation_examples.json`
- Загружать из конфигурации вместо хардкода
- Поддержка разных профилей бизнеса

### 2.5 Вынести стратегии продаж в JSON
- Создать `data/sales_strategies.json`
- Загружать по типу бизнеса
- Настраиваемые SPIN вопросы

### 2.6 Вынести правила общения в JSON
- Создать `data/communication_rules.json`
- Параметры: max_sentences, max_emoji, tone, formality
- Загружать по профилю бизнеса

### 2.7 Добавить поддержку мультиязычности (базовая)
- Параметр `language` в конфигурации
- Поддержка RU и EN
- Language files для текстов интерфейса

### 2.8 Сделать валюту настраиваемой
- Параметр `currency` в конфигурации
- Поддержка: RUB, USD, EUR, GBP
- Форматирование цен по локали

### 2.9 Настраиваемые форматы контактов
- Поддержка разных форматов телефонов
- Настройка через регион (RU, US, EU, etc.)

### 2.10 Обработать success_cases из JSON
- Добавить модель SuccessCase
- Использовать в ответах бота

### 2.11 Добавить template system для ответов
- Использовать Jinja2 или f-strings с плейсхолдерами
- Вынести шаблоны в конфигурацию

### 2.12 Сделать этапы воронки конфигурируемыми
- Вынести определения этапов в JSON
- Разные этапы для разных типов бизнеса

### 2.13 Добавить валидацию данных (pydantic)
- Переписать модели с использованием pydantic
- Валидация при загрузке JSON
- Детальные ошибки валидации

### 2.14 Создать примеры конфигураций
- 5+ примеров для разных типов бизнеса
- Готовые к использованию шаблоны

### 2.15 Настраиваемый тон общения
- Параметры: formal, friendly, professional, casual
- Влияет на выбор слов и структуру предложений

### 2.16 Гибкая структура FAQ
- Поддержка категорий
- Поддержка вложенных вопросов
- Поддержка мультиязычных FAQ

### 2.17 Настраиваемые эмодзи
- Разные наборы эмодзи для разных ниш
- Параметр включения/выключения эмодзи

### 2.18 Адаптивная длина ответов
- Параметры min/max sentences
- Зависит от типа бизнеса

## Этап 3: Оптимизация (9 задач)

### 3.1 Добавить индексацию для поиска FAQ
- Создать inverted index при загрузке
- Ускорить поиск с O(n) до O(log n)

### 3.2 Оптимизировать фильтр английских слов
- Объединить regex замены в один паттерн
- Один проход вместо множественных

### 3.3 Добавить кэширование результатов поиска
- LRU cache для частых запросов
- Настраиваемый TTL и размер кэша

### 3.4 Предвычислить query_words
- Вычислять один раз для всех FAQ
- Передавать как параметр

### 3.5 Оптимизировать обработку текста
- Минимизировать количество regex операций
- Использовать компилированные паттерны

### 3.6 Добавить connection pooling для Ollama
- Переиспользовать соединения
- Уменьшить overhead

### 3.7 Асинхронная загрузка FAQ
- Загружать FAQ в фоне при старте
- Не блокировать запуск бота

### 3.8 Оптимизировать размер контекста
- Умная обрезка старых сообщений
- Сохранение важных сообщений

### 3.9 Batch обработка для множественных запросов
- Группировать похожие запросы
- Отправлять батчами в Ollama

## Этап 4: Качество кода (15 задач)

### 4.1 Рефакторинг chat.py
- Разбить 403-строчную функцию на модули
- Создать отдельные файлы для каждого типа обработки

### 4.2 Вынести вложенные функции
- generate_progress_with_bar → module level
- animate_thinking_indicator → module level
- on_token → module level

### 4.3 Создать constants.py
- Все магические числа вынести в константы
- Группировать по назначению

### 4.4 Улучшить обработку ошибок
- Добавить structured logging
- Логировать детали всех ошибок
- Добавить error tracking (Sentry опционально)

### 4.5 Убрать дублирование кода
- Унифицировать логику очистки status_msg и loading
- Создать helper функции

### 4.6 Добавить type hints везде
- Проверить покрытие type hints
- Убрать Any где возможно

### 4.7 Добавить docstrings
- Все функции должны иметь docstrings
- Описать параметры и возвращаемые значения

### 4.8 Удалить закомментированный код
- Строки 423-434 chat.py
- Либо удалить, либо оформить как TODO

### 4.9 Вынести обработку UnicodeEncodeError в utility
- Создать safe_print() функцию
- Использовать везде вместо try-except обертокРазумеется! Продолжаю создание плана:

### 4.10 Singleton для конфигурации
- Избежать множественных созданий объекта
- Кэшировать конфигурацию

### 4.11 Добавить retry логику в базовый клиент
- Унифицировать retry для всех API запросов
- Настраиваемые параметры retry

### 4.12 Улучшить структуру проекта
- Разделить handlers по функциональности
- Создать четкую иерархию модулей

### 4.13 Добавить middleware для логирования
- Логировать все входящие сообщения
- Логировать время обработки

### 4.14 Создать error handlers
- Централизованная обработка ошибок
- Красивые сообщения пользователю

### 4.15 Code linting и formatting
- Настроить black, isort, flake8
- Привести весь код к единому стилю

## Этап 5: Улучшение ответов (10 задач)

### 5.1 Оптимизировать system prompt
- Сделать более универсальным
- Убрать специфику IT-услуг
- Добавить адаптацию под профиль бизнеса

### 5.2 Улучшить few-shot examples
- Разнообразить примеры
- Добавить примеры для разных типов бизнеса
- Загружать из конфигурации

### 5.3 Добавить контроль качества ответов
- Проверка релевантности ответа вопросу
- Проверка наличия запрещенных слов
- Проверка длины ответа

### 5.4 Улучшить форматирование ответов
- Проверить корректность переносов строк
- Улучшить работу с списками
- Добавить форматирование таблиц

### 5.5 Добавить персонализацию
- Использовать имя пользователя
- Учитывать историю диалога
- Адаптировать tone based on context

### 5.6 Улучшить обработку контекста
- Умное суммаризация длинной истории
- Выделение ключевых фактов
- Сохранение entity mentions

### 5.7 Добавить проверку фактов
- Верификация информации из FAQ
- Предотвращение галлюцинаций
- Ссылки на источники

### 5.8 Улучшить обработку эмодзи
- Умное размещение эмодзи
- Соответствие тону бизнеса
- Настраиваемые правила

### 5.9 Добавить variability в ответы
- Несколько вариантов фраз для одного и того же
- Избежать повторений
- Более естественный диалог

### 5.10 Оптимизировать temperature и параметры
- A/B тестирование параметров
- Подбор оптимальных значений
- Документация влияния параметров

## Этап 6: Универсальная система конфигурации (12 задач)

### 6.1 Создать data/business_profiles.json
- 7+ готовых профилей бизнеса
- Параметры для каждого профиля
- Примеры использования

### 6.2 Создать data/conversation_examples.json
- Примеры для каждого профиля
- Легко редактируемые
- Мультиязычные

### 6.3 Создать data/sales_strategies.json
- Стратегии для разных этапов воронки
- Настраиваемые вопросы
- Адаптивные CTA

### 6.4 Создать data/communication_rules.json
- Правила общения для каждого профиля
- Тон, длина, эмодзи
- Форматирование

### 6.5 Создать data/language_packs/
- ru.json, en.json
- Все интерфейсные тексты
- Легко добавлять новые языки

### 6.6 Добавить config/default_settings.yaml
- Значения по умолчанию для всех параметров
- Документация каждого параметра
- Примеры значений

### 6.7 Создать config loader с валидацией
- Загрузка всех конфигурационных файлов
- Валидация через pydantic
- Детальные ошибки при проблемах

### 6.8 Добавить currency и locale support
- Поддержка разных валют
- Форматирование чисел по локали
- Настройка через параметры

### 6.9 Настраиваемые эмодзи наборы
- data/emoji_sets.json
- Разные наборы для разных ниш
- Параметр включения/выключения

### 6.10 Гибкая структура FAQ
- Поддержка категорий и подкатегорий
- Мультиязычные FAQ
- Условное отображение FAQ

### 6.11 Template system для динамических ответов
- Использовать Jinja2 templates
- Плейсхолдеры для персонализации
- Вынести все шаблоны в файлы

### 6.12 Настраиваемые этапы воронки
- data/funnel_stages.json
- Разные воронки для разных бизнесов
- Гибкие переходы между этапами

## Этап 7: Производительность (8 задач)

### 7.1 Добавить inverted index для FAQ
- Предварительное индексирование при загрузке
- Быстрый поиск O(1) - O(log n)
- Поддержка обновления индекса

### 7.2 Добавить LRU cache для поиска
- Кэширование результатов частых запросов
- Настраиваемый размер кэша (100-1000 записей)
- TTL для инвалидации

### 7.3 Оптимизировать text filtering
- Один regex паттерн вместо цикла
- Минимизировать проходы по тексту
- Использовать compiled patterns

### 7.4 Connection pooling для Ollama
- Переиспользование HTTP соединений
- Настраиваемый размер пула
- Таймауты соединений

### 7.5 Асинхронная загрузка ресурсов
- FAQ, конфиги, модели загружать параллельно
- Не блокировать старт бота
- Progress indicator для загрузки

### 7.6 Batch processing для множественных запросов
- Группировка похожих запросов
- Batch API calls к Ollama
- Снижение latency

### 7.7 Оптимизация streaming
- Настройка buffer size
- Балансировка частоты обновлений
- Минимизация edit_text calls

### 7.8 Memory optimization
- Ограничение размера контекста
- Очистка старых данных
- Мониторинг использования памяти

## Этап 8: Качество и надежность (10 задач)

### 8.1 Добавить health checks
- Проверка Ollama
- Проверка БД
- Проверка конфигурации
- Endpoint /health

### 8.2 Добавить graceful shutdown
- Корректное завершение задач
- Сохранение состояния
- Закрытие соединений

### 8.3 Добавить rate limiting
- Защита от спама
- Лимиты на пользователя
- Настраиваемые лимиты

### 8.4 Добавить circuit breaker для Ollama
- Автоматический fallback при множественных ошибках
- Восстановление соединения
- Метрики доступности

### 8.5 Улучшить error messages для пользователей
- Красивые сообщения об ошибках
- Понятные инструкции
- Контакты поддержки

### 8.6 Добавить monitoring и metrics
- Prometheus metrics
- Response time tracking
- Error rate monitoring
- Success rate по типу запросов

### 8.7 Добавить structured logging
- JSON logging для анализа
- Correlation IDs для трейсинга
- Разные уровни детализации

### 8.8 Добавить backup и восстановление
- Автобэкап БД
- Восстановление после сбоев
- Миграции данных

### 8.9 Добавить security improvements
- Валидация входных данных
- Защита от injection
- Безопасное хранение токенов

### 8.10 Добавить admin панель (опционально)
- Просмотр статистики
- Управление FAQ
- Мониторинг ошибок

## Этап 9: Документация (6 задач)

### 9.1 Создать CUSTOMIZATION_GUIDE.md
- Подробный гайд по настройке под свой бизнес
- Примеры для 7 типов бизнеса
- FAQ по кастомизации

### 9.2 Создать API_DOCUMENTATION.md
- Документация всех модулей
- Примеры использования
- Параметры конфигурации

### 9.3 Создать CONFIGURATION_REFERENCE.md
- Описание всех параметров
- Диапазоны значений
- Рекомендации по настройке

### 9.4 Создать TROUBLESHOOTING.md
- Частые проблемы и решения
- Как читать логи
- Как диагностировать ошибки

### 9.5 Обновить README с новыми возможностями
- Добавить информацию о профилях бизнеса
- Описать новые фичи
- Обновить примеры

### 9.6 Создать MIGRATION_GUIDE.md
- Как обновить с предыдущей версии
- Breaking changes
- Миграция данных

## Этап 10: Тестирование (опционально, 5 задач)

### 10.1 Unit тесты для утилит
- text_filter.py
- search.py
- config.py

### 10.2 Integration тесты для handlers
- chat.py
- start.py
- menu.py

### 10.3 Тесты для разных профилей бизнеса
- Проверка работы каждого профиля
- Валидация ответов
- Проверка качества

### 10.4 Performance тесты
- Load testing
- Stress testing
- Benchmark для поиска

### 10.5 E2E тесты
- Полный цикл диалога
- Проверка всех команд
- Проверка UI элементов

---

## Итого: 101 задача

- Этап 1 (Баги): 13 задач
- Этап 2 (Универсальность): 18 задач  
- Этап 3 (Оптимизация): 9 задач
- Этап 4 (Качество): 15 задач
- Этап 5 (Ответы): 10 задач
- Этап 6 (Конфигурация): 12 задач
- Этап 7 (Документация): 6 задач
- Этап 8 (Надежность): 10 задач
- Этап 9 (Тесты): 5 задач (опционально)
- Доп задачи: 3 задачи

## Ожидаемый результат

После выполнения плана:
- ✅ Все критические баги исправлены
- ✅ Бот работает для любого типа бизнеса (7+ профилей готовы)
- ✅ Кастомизация через JSON без изменения кода
- ✅ Высокая производительность (поиск в 10-100x быстрее)
- ✅ Production-ready качество кода
- ✅ Полная документация на RU и EN
- ✅ Улучшенное качество ответов
- ✅ Мониторинг и метрики

## Время выполнения

Ориентировочно: 250-350 инструментальных вызовов для полного выполнения всех этапов.
