# Комплексный план улучшения бота

## Обнаруженные проблемы

### Критические баги (требуют немедленного исправления)

1. **Логическая ошибка в streaming** (`chat.py:238`)
   - `streaming_success` всегда False в except блоке
   - Приводит к некорректной обработке успешных streaming запросов

2. **TimeoutError не запускает fallback** (`chat.py:298`)
   - После таймаута код не переходит к fallback-поиску
   - Пользователь получает пустой ответ

3. **Race condition** (`chat.py:27`)
   - Глобальный словарь `_last_tips_shown` без блокировок
   - При параллельных запросах возможна потеря данных

4. **Конфликт в фильтре английских слов** (`text_filter.py:135`)
   - Удаление всех латинских букв после замены по словарю
   - Теряются корректные замены

5. **Ложные совпадения в поиске** (`search.py:42`)
   - Поиск подстрок вместо целых слов
   - "год" совпадает с "много"

### Проблемы универсальности

6. **Хардкод IT-услуг B2B**
   - Примеры диалогов (`prompts.py:13-70`)
   - Стратегии продаж (`prompts.py:75-100`)
   - Структура сервисов не подходит для товаров/подписок

7. **Только русский язык**
   - Нет мультиязычности
   - Хардкод правил на русском

8. **Жесткие структуры данных**
   - `Company` и `Service` не расширяемы
   - Нет поддержки разных типов бизнеса

### Проблемы производительности

9. **Линейный поиск FAQ** (`search.py:95-98`)
   - O(n) для каждого запроса
   - Медленно для больших баз (1000+ элементов)

10. **Неэффективная замена слов** (`text_filter.py:123-126`)
    - O(n×m) цикл по словарю
    - Множественные проходы по тексту

### Проблемы качества кода

11. **Огромная функция** (`chat.py:32-435`)
    - 403 строки в одной функции
    - Нарушение Single Responsibility Principle

12. **Широкие except блоки**
    - `except Exception: pass` скрывает проблемы
    - Нет логирования ошибок

13. **Нет валидации данных**
    - `config.py`: нет проверки диапазонов параметров
    - `faq_loader.py`: нет валидации JSON

---

## План улучшений

### Фаза 1: Исправление критических багов (приоритет: высокий)

#### 1.1 Исправить логику streaming
- Переделать обработку `streaming_success`
- Убрать противоречия в условиях
- Добавить логирование для отладки

#### 1.2 Исправить fallback при таймауте
- Добавить корректный переход к fallback
- Убедиться что пользователь всегда получает ответ

#### 1.3 Исправить race condition
- Добавить `asyncio.Lock` для глобального словаря
- Или использовать Redis для распределенных блокировок

#### 1.4 Исправить фильтр английских слов
- Сначала удалять целые английские слова
- Затем применять замены по словарю
- Не трогать уже замененные части

#### 1.5 Исправить поиск FAQ
- Использовать границы слов `\b` в regex
- Добавить токенизацию для точного поиска

### Фаза 2: Улучшение универсальности (приоритет: высокий)

#### 2.1 Сделать структуры данных гибкими
- Добавить `entity_type` в Service (service/product/subscription/course)
- Добавить `metadata: dict[str, Any]` для расширения
- Сделать опциональными специфичные поля

#### 2.2 Вынести бизнес-логику в конфигурацию
- Примеры диалогов → `data/examples.json`
- Стратегии продаж → `data/strategies.json`
- Правила общения → `data/rules.json`

#### 2.3 Добавить профили бизнеса
- B2B Services
- B2C Products
- E-commerce
- SaaS
- Education
- Healthcare
- Real Estate

#### 2.4 Поддержка мультиязычности
- Добавить параметр языка в конфигурацию
- Вынести все тексты в language files
- Поддержать минимум: RU, EN

### Фаза 3: Оптимизация производительности (приоритет: средний)

#### 3.1 Оптимизировать поиск FAQ
- Добавить индексацию (inverted index)
- Кэшировать результаты частых запросов
- Предвычислить `query_words` один раз

#### 3.2 Оптимизировать фильтрацию текста
- Объединить regex замены в один паттерн
- Минимизировать количество проходов

#### 3.3 Добавить кэширование
- Кэш для результатов поиска
- Кэш для промптов
- Настраиваемый TTL

### Фаза 4: Улучшение качества кода (приоритет: средний)

#### 4.1 Рефакторинг chat.py
- Разбить на модули:
  - `quick_faq_handler.py`
  - `streaming_handler.py`
  - `fallback_handler.py`
  - `response_sender.py`
- Вынести вложенные функции
- Убрать дублирование

#### 4.2 Улучшить обработку ошибок
- Заменить `print()` на `logger`
- Добавить конкретные except блоки
- Логировать детали ошибок
- Добавить метрики ошибок

#### 4.3 Добавить валидацию
- Использовать `pydantic` для моделей данных
- Валидировать JSON при загрузке
- Проверять диапазоны параметров
- Валидировать форматы (email, phone, URL)

#### 4.4 Вынести константы
- Создать `constants.py`
- Перенести все магические числа
- Сделать настраиваемыми через конфигурацию

### Фаза 5: Документация и тестирование (приоритет: средний)

#### 5.1 Документация
- Гайд по кастомизации под разные типы бизнеса
- JSON Schema для валидации данных
- Примеры конфигураций (5+ типов бизнеса)
- API документация для разработчиков

#### 5.2 Тестирование
- Unit-тесты для всех утилит
- Интеграционные тесты для обработчиков
- Тесты для разных типов бизнеса
- Тесты производительности

---

## Приоритизация работ

### Немедленно (критично для работоспособности):
1. Исправить логику streaming (баг в chat.py)
2. Исправить TimeoutError fallback
3. Исправить фильтр английских слов
4. Исправить поиск FAQ (ложные совпадения)

### Срочно (для универсальности):
5. Добавить профили бизнеса
6. Сделать структуры данных гибкими
7. Вынести бизнес-логику в конфигурацию
8. Добавить валидацию данных

### Важно (для качества):
9. Рефакторинг chat.py (разбить на модули)
10. Оптимизировать поиск FAQ
11. Улучшить обработку ошибок
12. Вынести константы

### Желательно (для расширения):
13. Поддержка мультиязычности
14. Кэширование
15. Документация по кастомизации
16. Тесты

---

## Ожидаемый результат

После выполнения плана:
- ✅ Бот работает без критических багов
- ✅ Универсален для любого типа бизнеса
- ✅ Легко кастомизируется через JSON (без изменения кода)
- ✅ Высокая производительность даже для больших баз FAQ
- ✅ Профессиональное качество кода
- ✅ Полная документация

Время на реализацию всех фаз: 200-300 инструментальных вызовов.
